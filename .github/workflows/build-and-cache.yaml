# .github/workflows/build-and-cache.yml
name: "Build and Cache Flake Packages"

on:
  push:
    branches:
      - "main"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Install Nix"
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: "Configure Cachix"
        # This step is still needed. It installs the 'cachix' command
        # and securely provides the authentication token as an
        # environment variable for the next step.
        uses: cachix/cachix-action@v15
        with:
          name: ${{ secrets.CACHIX_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: "Build and Push to Cachix"
        # This is the corrected step.
        # We explicitly tell cachix to watch the 'nix build' command
        # and push the resulting store paths to your cache.
        run: cachix watch-exec ${{ secrets.CACHIX_NAME }} -- nix build .#proton-sarek-async