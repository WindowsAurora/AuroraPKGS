# .github/workflows/build-and-cache.yml
name: "Build and Cache Flake Packages"

on:
  # Run on pushes to the 'main' branch
  push:
    branches:
      - "main"
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Install Nix"
        uses: cachix/install-nix-action@v27
        with:
          # Enable flakes and the new nix command interface
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: "Configure Cachix"
        # This action will automatically configure Nix to use your Cachix cache
        # and will wrap the subsequent build step to push the results.
        uses: cachix/cachix-action@v15
        with:
          # The name of your Cachix cache.
          # To keep this private, we store it in a GitHub secret.
          name: aurora

          # The authentication token for your Cachix cache.
          # This MUST be stored in a secret.
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: "Build Flake Package"
        # The cachix-action from the previous step wraps this command.
        # It builds the package and automatically pushes the output paths
        # to your configured cache.
        run: nix build .#proton-sarek-async